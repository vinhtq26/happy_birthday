<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Memories ‚ú®</title>
    <link rel="stylesheet" href="music.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Quicksand:wght@300;400;500;600&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg,
                    #ffd1dc 0%,
                    #e6e6fa 25%,
                    #ffefd5 50%,
                    #e6e6fa 75%,
                    #ffd1dc 100%);
            background-size: 400% 400%;
            animation: gradientFlow 15s ease infinite;
            font-family: 'Quicksand', sans-serif;
            overflow-x: hidden;
            color: #4a4a4a;
        }

        @keyframes gradientFlow {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* Enhanced Sparkle Effect */
        .magic-sparkles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .sparkle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: white;
            animation: twinkle var(--duration, 4s) ease-in-out infinite;
            opacity: 0;
        }

        @keyframes twinkle {

            0%,
            100% {
                opacity: 0;
                transform: scale(0.5);
            }

            50% {
                opacity: 0.8;
                transform: scale(1);
            }
        }

        /* Generate 50 sparkles with different positions and animations */
        .magic-sparkles::before,
        .magic-sparkles::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: radial-gradient(circle, white 1px, transparent 1px);
            background-size: 50px 50px;
            animation: sparkleLayer 8s linear infinite;
            opacity: 0.5;
        }

        .magic-sparkles::after {
            animation-delay: -4s;
            transform: rotate(45deg);
        }

        @keyframes sparkleLayer {
            0% {
                transform: translateY(0);
            }

            100% {
                transform: translateY(-50px);
            }
        }

        /* Floating Hearts */
        .floating-hearts {
            position: fixed;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        .heart {
            position: absolute;
            font-size: 1.5rem;
            color: rgba(255, 105, 180, 0.6);
            animation: floatHeart var(--float-duration, 6s) ease-in-out infinite;
            animation-delay: var(--delay, 0s);
        }

        @keyframes floatHeart {
            0% {
                transform: translate(0, 100vh) rotate(0deg);
            }

            100% {
                transform: translate(var(--translate-x, 0), -100vh) rotate(360deg);
            }
        }

        /* Welcome Section */
        .welcome {
            text-align: center;
            padding: 4rem 2rem;
            position: relative;
            z-index: 3;
        }

        .welcome h1 {
            font-family: 'Dancing Script', cursive;
            font-size: 4rem;
            color: #ff69b4;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            animation: fadeInScale 2s ease;
        }

        .welcome p {
            font-size: 1.2rem;
            max-width: 600px;
            margin: 1.5rem auto;
            line-height: 1.6;
            animation: fadeIn 2s ease 0.5s both;
        }

        /* Enhanced Memory Cards */
        .memory-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            z-index: 3;
            position: relative;
        }

        /* Infinite photo loop (left -> right) */
        .memory-marquee {
            --marquee-duration: 22s;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem 0;
            overflow: hidden;
            z-index: 3;
            position: relative;

            /* Soft fade on edges */
            -webkit-mask-image: linear-gradient(to right, transparent, black 8%, black 92%, transparent);
            mask-image: linear-gradient(to right, transparent, black 8%, black 92%, transparent);
        }

        .memory-track {
            display: flex;
            width: max-content;
            will-change: transform;
            animation: memoryMarquee var(--marquee-duration) linear infinite;
            animation-play-state: paused;
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
        }

        .memory-marquee.is-ready .memory-track {
            animation-play-state: running;
        }

        .memory-marquee.is-paused .memory-track {
            animation-play-state: paused;
        }

        /* Pause on hover only on devices that actually support hover */
        @media (hover: hover) and (pointer: fine) {
            .memory-marquee.is-ready:hover .memory-track {
                animation-play-state: paused;
            }
        }

        .memory-set {
            display: flex;
            align-items: stretch;
            gap: 2rem;
            padding: 0 2rem;
        }

        .memory-marquee .memory-card {
            width: 320px;
            flex: 0 0 auto;
        }

        .memory-marquee .memory-img {
            height: 230px;
        }

        @keyframes memoryMarquee {
            from {
                transform: translate3d(0, 0, 0);
            }

            to {
                transform: translate3d(-50%, 0, 0);
            }
        }

        .memory-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .memory-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .memory-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transform: translateX(-100%);
            transition: 0.5s;
        }

        .memory-card:hover::before {
            transform: translateX(100%);
        }

        .memory-img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            object-position: 50% 50%;
            border-radius: 15px;
            margin-bottom: 1rem;
            transition: transform 0.5s ease;
            transform: scale(var(--hb-zoom, 1));
        }

        .memory-img.hb-portrait {
            object-position: 50% var(--hb-focus-y, 10%);
        }

        /* For photos that would crop the face: show the whole image */
        .memory-img.hb-contain {
            object-fit: contain;
            object-position: 50% 50%;
            background: rgba(255, 255, 255, 0.55);
        }

        /* Zoom/crop style (used for image #5 so the portrait doesn't look small) */
        .memory-img.hb-zoom {
            object-fit: cover;
            object-position: 50% 25%;
            --hb-zoom: 1.12;
        }

        /* Make the portrait (image #5) feel less "small" inside its frame */
        .memory-img.hb-tall {
            height: 320px;
        }

        .memory-marquee .memory-img.hb-tall {
            height: 280px;
        }

        .memory-card:hover .memory-img {
            transform: scale(calc(var(--hb-zoom, 1) * 1.05));
        }

        .memory-date {
            font-family: 'Dancing Script', cursive;
            color: #ff69b4;
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }

        .memory-caption {
            font-size: 1rem;
            line-height: 1.5;
            color: #666;
        }

        /* Final Message Section */
        .final-message {
            text-align: center;
            padding: 4rem 2rem;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            margin-top: 3rem;
            position: relative;
            z-index: 3;
        }

        .final-message h2 {
            font-family: 'Dancing Script', cursive;
            font-size: 3rem;
            color: #ff69b4;
            margin-bottom: 2rem;
            animation: heartbeat 2s infinite;
        }

        @keyframes heartbeat {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .final-message p {
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto 2rem;
            line-height: 1.8;
        }

        .goodbye-btn {
            display: inline-block;
            padding: 1rem 2rem;
            font-size: 1.2rem;
            background: linear-gradient(45deg, #ff69b4, #da70d6);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(255, 105, 180, 0.4);
            animation: float 3s infinite ease-in-out;
        }

        .goodbye-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(255, 105, 180, 0.6);
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        /* Animations */
        @keyframes fadeInScale {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes fadeIn {
            0% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        /* Generate Hearts */
        .js-generate-hearts {
            position: fixed;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.4);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #ff69b4, #da70d6);
            border-radius: 6px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .welcome h1 {
                font-size: 3rem;
            }

            .memory-marquee {
                padding: 1rem 0;
            }

            .memory-marquee .memory-card {
                width: 260px;
            }

            .memory-marquee .memory-img {
                height: 170px;
            }

            .final-message h2 {
                font-size: 2.5rem;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            .memory-track {
                animation: none;
                transform: none;
            }
        }
    </style>
</head>

<body>
    <div class="magic-sparkles"></div>
    <div class="floating-hearts">
        <div class="heart" style="--float-duration: 6s; --delay: 0s; --translate-x: 20px;">üíù</div>
        <div class="heart" style="--float-duration: 8s; --delay: 1s; --translate-x: -30px;">üíñ</div>
        <div class="heart" style="--float-duration: 7s; --delay: 2s; --translate-x: 40px;">üíó</div>
        <div class="heart" style="--float-duration: 9s; --delay: 3s; --translate-x: -20px;">üíì</div>
        <div class="heart" style="--float-duration: 5s; --delay: 4s; --translate-x: 30px;">üíï</div>
    </div>

    <section class="welcome">
        <h1>To our dear son ‚ú®</h1>
        <p>You‚Äôre another year older. We don‚Äôt need you to be the best at everything ‚Äî we just hope you keep trying,
            live with kindness, and learn to take care of yourself. We‚Äôre always here when you need us.</p>
    </section>

    <div class="memory-marquee" aria-label="Memory loop">
        <div class="memory-track">
            <div class="memory-set">
                <!-- Populated by JS from ./images/* -->
            </div>
        </div>
    </div>


    <section class="final-message">
        <h2 id="birthday-title">Happy Birthday! üéÇ</h2>
        <p>Today is your day, and we just want to tell you a few things:<br>
            Keep being brave, calm, and persistent. Success is built from small steps every day.<br>
            Whether you feel happy or sad, your family will always be a place you can come back to. üå∏</p>
        <p>We hope you grow into a kind young man ‚Äî responsible, loving, and never giving up when things get tough.
            We believe in you. üíù</p>
        <button type="button" class="goodbye-btn">Tap here <span id="curious-icon"
                style="font-size:1.5em;vertical-align:middle;cursor:pointer;transition:transform 0.2s;">üïµÔ∏è‚Äç‚ôÇÔ∏è‚ú®</span></button>
        <canvas id="fireworks-canvas"
            style="position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:999;display:none;"></canvas>
        <div id="custom-popup"
            style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:1000;align-items:center;justify-content:center;">
            <div
                style="background:white;border-radius:20px;box-shadow:0 8px 32px rgba(255,105,180,0.3);padding:2rem 2.5rem;max-width:90vw;text-align:center;position:relative;animation:fadeInScale 0.5s;">
                <span style="font-size:2.5rem;">üéâüéÇüíñ</span>
                <h3 style="font-family:'Dancing Script',cursive;color:#ff69b4;margin:1rem 0 0.5rem;">Happy birthday,
                    our son!
                </h3>
                <p style="font-size:1.2rem;line-height:1.6;margin-bottom:1.5rem;">Thank you for being in our lives and
                    growing into such a wonderful kid. We wish you good health, confidence, and happiness ‚Äî in school,
                    at work, and in everything you do. üòä<br>
                    <br>
                    Whenever you need it, come home ‚Äî we‚Äôll always be here for you. ‚ù§Ô∏è<br>
                </p>
                <button id="agree-popup" type="button"
                    style="padding:0.7rem 2rem;font-size:1rem;background:linear-gradient(45deg,#ff69b4,#da70d6);color:white;border:none;border-radius:50px;cursor:pointer;box-shadow:0 2px 8px rgba(255,105,180,0.2);transition:background 0.3s,transform 0.2s;">Aww,
                    thank you</button>
            </div>
        </div>
    </section>

    <script src="./config.js"></script>
    <audio id="bg-music" src="./music/happy-birthday.mp3"></audio>
    <audio id="fireworks-sfx" src="./music/new-year.mp3" preload="auto"></audio>
    <button id="music-toggle" class="music-toggle" type="button" aria-label="Toggle music"
        aria-pressed="false">‚ô´</button>
    <script src="music.js"></script>
    <script src="image-focus.js"></script>
    <script>
        function buildMemoryCards() {
            const setEl = document.querySelector('.memory-set');
            if (!setEl) return;

            // Use ALL images in ./images (static list)
            // Note: keep URL-encoding for spaces.
            const imageFiles = [
                'image.png',
                'image%20copy.png',
                'image%20copy%202.png',
                'image%20copy%203.png',
                'image%20copy%204.png',
                'image%20copy%205.png',
                'image%20copy%206.png',
                'image%20copy%207.png',
                'image%20copy%208.png',
                'image%20copy%209.png',
                'image%20copy%2010.png',
            ];

            const titleTemplates = [
                'Family Day',
                'Home Moments',
                'Together Again',
                'Our Favorite People',
                'With Mom',
                'Sibling Time',
                'Side by Side',
                'Growing Up Together',
                'Mom & Son',
                'With Dad',
                'Just You',
            ];

            const captionTemplates = [
                'Family is your first team, and we‚Äôll always be right here for you, son ‚Äî in the easy days and the hard ones too. ‚ú®',
                'Home feels warmer and brighter because of you, and your laughter is the kind of sound we never get tired of. üíõ',
                'No matter how busy life gets, these moments stay with us ‚Äî little reminders of how far you‚Äôve come. üåø',
                'Together is our favorite place to be, because being with you turns ordinary days into something special. üì∏',
                'With Mom ‚Äî your first best friend and your forever safe place, where you can always come back and be yourself. üíó',
                'With your sibling ‚Äî laughter, little adventures, and big love, even when you tease each other sometimes. ü§ç',
                'Side by side, always cheering each other on ‚Äî two hearts learning and growing together. üåü',
                'Growing up together, one memory at a time ‚Äî and every year, you both shine a little brighter. üå∏',
                'Mom & son ‚Äî a love that never changes, no matter how tall you get or how far you go. ü´∂',
                'With Dad ‚Äî steady support and a proud heart, always wishing you courage, calm, and confidence. üí´',
                'Just you ‚Äî growing, learning, and becoming more yourself every day; we‚Äôre proud of the person you‚Äôre turning into. üå±',
            ];

            // Clear existing
            setEl.innerHTML = '';

            const imgs = [];

            imageFiles.forEach((file, index) => {
                const card = document.createElement('div');
                card.className = 'memory-card';

                const img = document.createElement('img');
                img.className = 'memory-img';
                img.src = `./images/${file}`;
                imgs.push(img);

                // Index is 0-based:
                // - Image #4 (index 3): keep "contain" to avoid awkward cropping.
                // - Images #5-#11 (index 4-10): use zoom/crop so portraits don't look small.
                if (index === 3) {
                    img.classList.add('hb-contain');
                }

                if (index >= 4) {
                    img.classList.add('hb-zoom');
                }

                // Image #5 (index 4): a bit stronger zoom than the rest
                if (index === 4) {
                    img.style.setProperty('--hb-zoom', '1.18');
                }

                const n = index + 1;
                const fileLabel = decodeURIComponent(file)
                    .replace(/\.[a-z0-9]+$/i, '')
                    .replace(/_/g, ' ')
                    .trim();
                const titleBase = titleTemplates[index % titleTemplates.length];
                img.alt = `Memory ${String(n).padStart(2, '0')}: ${fileLabel || titleBase}`;

                const date = document.createElement('div');
                date.className = 'memory-date';
                date.textContent = `${titleBase} #${String(n).padStart(2, '0')}`;

                const cap = document.createElement('div');
                cap.className = 'memory-caption';
                cap.textContent = captionTemplates[index % captionTemplates.length];

                card.appendChild(img);
                card.appendChild(date);
                card.appendChild(cap);
                setEl.appendChild(card);
            });

            // Wait until the newly created images finish loading, otherwise the track width
            // can change mid-animation (causes a small "jitter"/jump).
            const waitForImg = (imgEl) => new Promise((resolve) => {
                if (!imgEl) return resolve();
                if (imgEl.complete) return resolve();
                imgEl.addEventListener('load', resolve, { once: true });
                imgEl.addEventListener('error', resolve, { once: true });
            });

            return Promise.all(imgs.map(waitForImg));
        }

        // Infinite memory loop (left -> right)
        function initMemoryMarquee() {
            const marquee = document.querySelector('.memory-marquee');
            if (!marquee) return;

            const track = marquee.querySelector('.memory-track');
            const firstSet = marquee.querySelector('.memory-set');
            if (!track || !firstSet) return;

            // Ensure exactly 2 identical sets for a seamless loop
            const sets = Array.from(track.querySelectorAll('.memory-set'));
            sets.slice(1).forEach((node) => node.remove());

            const clone = firstSet.cloneNode(true);
            clone.setAttribute('aria-hidden', 'true');
            track.appendChild(clone);

            // Tap/click an image to pause; tap/click again to resume
            marquee.addEventListener('click', (e) => {
                const target = e.target;
                if (!(target instanceof Element)) return;
                if (!target.classList.contains('memory-img')) return;
                marquee.classList.toggle('is-paused');
            });
        }

        window.addEventListener('load', async () => {
            await buildMemoryCards();
            initMemoryMarquee();
            document.querySelector('.memory-marquee')?.classList.add('is-ready');
        });

        // Set name from config.js
        if (typeof recipientName !== 'undefined') {
            document.getElementById('birthday-title').innerHTML = `Happy Birthday ${recipientName}! üéÇ`;
        }

        // Fireworks effect
        function launchFireworks() {
            const canvas = document.getElementById('fireworks-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            // Cancel any previous show
            if (window.__hbFireworksRAF) {
                cancelAnimationFrame(window.__hbFireworksRAF);
                window.__hbFireworksRAF = null;
            }

            // Total duration control
            const TOTAL_MS = 34000; // total duration ~ 34 seconds
            const FINALE_AT_MS = 8000; // slow at first, then ‚Äúfinale‚Äù after 8s
            const END_AT_MS = TOTAL_MS;

            // Make it softer (less eye-straining) but still colorful
            const MASTER_INTENSITY = 0.56;

            // Reduce overall density (particles/rockets) to avoid glare
            // 0.80 ~= 20% less dense
            const DENSITY = 0.80;

            function resize() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }

            resize();
            canvas.style.display = 'block';

            // Avoid pure white to reduce glare
            const colors = ['#ff69b4', '#ffd700', '#00e6e6', '#ff6347', '#7cfc00', '#da70d6'];
            const randomBetween = (a, b) => a + Math.random() * (b - a);
            const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];

            const rockets = [];
            let particles = [];
            let lastRocketAt = 0;
            let startAt = performance.now();
            let currentFinaleProgress = 0;

            function createExplosion(x, y, intensity) {
                let baseCount = intensity === 'finale' ? 130 : 70;
                if (intensity === 'finale') {
                    // Taper particle amount near the end so it looks less dense
                    const taper = 1 - 0.40 * currentFinaleProgress; // 1.0 -> 0.60
                    baseCount *= taper;
                }
                baseCount *= DENSITY;
                const count = Math.floor(baseCount * randomBetween(0.85, 1.10));
                const color = pick(colors);

                for (let i = 0; i < count; i++) {
                    const angle = (Math.PI * 2 * i) / count + randomBetween(-0.03, 0.03);
                    const speed = (intensity === 'finale' ? randomBetween(2.0, 7.2) : randomBetween(1.4, 5.4)) * (Math.random() < 0.06 ? 1.25 : 1);
                    const size = randomBetween(0.9, intensity === 'finale' ? 2.2 : 1.9);
                    const life = intensity === 'finale' ? randomBetween(68, 112) : randomBetween(55, 98);

                    particles.push({
                        x,
                        y,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed,
                        alpha: 1,
                        color,
                        size,
                        life,
                        maxLife: life,
                        twinkle: Math.random() < 0.14,
                    });
                }

                // Optional second ring for fuller look
                if (intensity === 'finale' && Math.random() < 0.30) {
                    const ringCount = Math.max(10, Math.floor(randomBetween(16, 26) * DENSITY));
                    const ringColor = pick(colors);
                    for (let i = 0; i < ringCount; i++) {
                        const angle = (Math.PI * 2 * i) / ringCount;
                        const speed = randomBetween(2.4, 4.8);
                        const life = randomBetween(54, 90);
                        particles.push({
                            x,
                            y,
                            vx: Math.cos(angle) * speed,
                            vy: Math.sin(angle) * speed,
                            alpha: 1,
                            color: ringColor,
                            size: randomBetween(1.0, 1.9),
                            life,
                            maxLife: life,
                            twinkle: true,
                        });
                    }
                }
            }

            function spawnRocket(intensity) {
                const w = canvas.width;
                const h = canvas.height;

                const x = randomBetween(0.12, 0.88) * w;
                const y = h + randomBetween(10, 80);
                const targetY = randomBetween(intensity === 'finale' ? 0.14 : 0.22, intensity === 'finale' ? 0.52 : 0.48) * h;
                const vx = randomBetween(-0.7, 0.7);
                const vy = -randomBetween(intensity === 'finale' ? 10.5 : 8.0, intensity === 'finale' ? 15.0 : 12.0);
                const color = pick(colors);
                rockets.push({
                    x,
                    y,
                    prevX: x,
                    prevY: y,
                    vx,
                    vy,
                    targetY,
                    color,
                    exploded: false,
                });
            }

            function step(now) {
                const t = now - startAt;
                const w = canvas.width;
                const h = canvas.height;

                // Fade previous frame without painting a black rectangle (keeps background visible)
                ctx.globalCompositeOperation = 'destination-out';
                ctx.fillStyle = 'rgba(0, 0, 0, 0.26)';
                ctx.fillRect(0, 0, w, h);
                // Draw in normal mode to reduce glare
                ctx.globalCompositeOperation = 'source-over';

                const intensity = t >= FINALE_AT_MS ? 'finale' : 'slow';
                currentFinaleProgress = intensity === 'finale'
                    ? Math.max(0, Math.min(1, (t - FINALE_AT_MS) / Math.max(1, (END_AT_MS - FINALE_AT_MS))))
                    : 0;

                // Finale starts dense, then thins out near the end
                const spawnInterval = intensity === 'finale'
                    ? Math.round((160 + currentFinaleProgress * 290) / DENSITY) // fewer rockets
                    : Math.round(950 / DENSITY);

                if (t < END_AT_MS && now - lastRocketAt >= spawnInterval) {
                    spawnRocket(intensity);
                    lastRocketAt = now;
                    const extraChance = 0.40 * (1 - 0.85 * currentFinaleProgress) * DENSITY;
                    if (intensity === 'finale' && Math.random() < extraChance) {
                        // Extra rockets during finale
                        spawnRocket(intensity);
                    }
                }

                // Update & draw rockets
                for (let i = rockets.length - 1; i >= 0; i--) {
                    const r = rockets[i];
                    r.prevX = r.x;
                    r.prevY = r.y;
                    r.x += r.vx;
                    r.y += r.vy;
                    r.vy += 0.10; // gravity pulls rocket down slightly near peak

                    // Trail
                    ctx.globalAlpha = 0.34 * MASTER_INTENSITY;
                    ctx.strokeStyle = r.color;
                    ctx.lineWidth = 1.2;
                    ctx.beginPath();
                    ctx.moveTo(r.prevX, r.prevY);
                    ctx.lineTo(r.x, r.y);
                    ctx.stroke();

                    // Small spark at the rocket head
                    ctx.globalAlpha = 0.55 * MASTER_INTENSITY;
                    ctx.fillStyle = r.color;
                    ctx.beginPath();
                    ctx.arc(r.x, r.y, 1.2, 0, Math.PI * 2);
                    ctx.fill();

                    const reachedPeak = r.y <= r.targetY || r.vy >= -0.5;
                    if (reachedPeak && !r.exploded) {
                        r.exploded = true;
                        createExplosion(r.x, r.y, intensity);
                        rockets.splice(i, 1);
                    }
                }

                // Update & draw particles
                const drag = 0.985;
                const gravity = 0.06;

                // Slight additive only for particles (low alpha), keeps colors vivid without harsh glare
                ctx.globalCompositeOperation = 'lighter';

                for (let i = particles.length - 1; i >= 0; i--) {
                    const p = particles[i];
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vx *= drag;
                    p.vy = p.vy * drag + gravity;
                    p.life -= 1;

                    const lifeRatio = p.life / p.maxLife;
                    let alpha = Math.max(0, Math.min(1, lifeRatio));
                    if (p.twinkle) alpha *= randomBetween(0.6, 1);
                    p.alpha = alpha;

                    const softness = intensity === 'finale' ? 0.48 : 0.64;
                    ctx.globalAlpha = p.alpha * softness * MASTER_INTENSITY;
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();

                    if (p.life <= 0 || p.alpha <= 0.01 || p.x < -50 || p.x > w + 50 || p.y > h + 80) {
                        particles.splice(i, 1);
                    }
                }

                // Finish when done
                if (t >= END_AT_MS && rockets.length === 0 && particles.length === 0) {
                    canvas.style.display = 'none';
                    window.__hbFireworksRAF = null;
                    return;
                }

                window.__hbFireworksRAF = requestAnimationFrame(step);
            }

            window.addEventListener('resize', resize, { passive: true });
            window.__hbFireworksRAF = requestAnimationFrame(step);
        }

        function playFireworksSfx() {
            const sfx = document.getElementById('fireworks-sfx');
            if (!sfx) return;
            sfx.volume = 0.85;
            try {
                sfx.currentTime = 0;
            } catch {
                // ignore
            }
            const p = sfx.play();
            if (p && typeof p.catch === 'function') {
                p.catch(() => {
                    // ignore autoplay/gesture issues
                });
            }
        }

        // Open popup (click + mobile tap)
        function openPopup(e) {
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }
            setTimeout(() => {
                document.getElementById('custom-popup').style.display = 'flex';
            }, 800);
        }

        const goodbyeBtn = document.querySelector('.goodbye-btn');
        if (goodbyeBtn) {
            goodbyeBtn.addEventListener('click', openPopup);
            // Some mobile browsers navigate on tap for anchors; this keeps behavior stable.
            goodbyeBtn.addEventListener('touchend', openPopup, { passive: false });
        }

        // Launch fireworks when the popup button is clicked
        document.getElementById('agree-popup').addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            playFireworksSfx();
            launchFireworks();
            setTimeout(() => {
                document.getElementById('custom-popup').style.display = 'none';
            }, 120);
        });

        // Close the popup when clicking outside
        document.getElementById('custom-popup').addEventListener('click', function (e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });

        // Add a click animation for the icon
        const curiousIcon = document.getElementById('curious-icon');
        if (curiousIcon) {
            curiousIcon.addEventListener('click', function (e) {
                e.stopPropagation();
                curiousIcon.style.transform = 'scale(1.5) rotate(20deg)';
                setTimeout(() => {
                    curiousIcon.style.transform = '';
                }, 300);
                // Show popup when clicking the icon
                setTimeout(() => {
                    document.getElementById('custom-popup').style.display = 'flex';
                }, 800);
            });
        }
    </script>
</body>

</html>
